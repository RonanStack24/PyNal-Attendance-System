<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Student Management</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial,
          sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #2c3e50;
      }

      .top-bar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 16px 30px;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .menu-toggle {
        display: none;
        background: none;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
      }

      .main-layout {
        display: flex;
        min-height: calc(100vh - 110px);
      }

      .sidebar {
        width: 240px;
        background: #2c3e50;
        color: #fff;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .nav-item {
        padding: 18px 25px;
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 0.3px;
        cursor: pointer;
        text-decoration: none;
        color: #ecf0f1;
        display: block;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }

      .nav-item:hover {
        background-color: #34495e;
        color: #fff;
      }

      .nav-item.active {
        background-color: #34495e;
        border-left: 4px solid #667eea;
        color: #fff;
      }

      .content {
        flex: 1;
        padding: 40px;
        background-color: #f5f7fa;
      }

      .page-header {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
      }

      .management-area {
        display: flex;
        gap: 30px;
        align-items: flex-start;
      }

      .student-card {
        width: 340px;
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
        position: sticky;
        top: 20px;
      }

      .avatar {
        width: 100px;
        height: 100px;
        border: 4px solid #667eea;
        border-radius: 50%;
        margin: 0 auto 25px;
        background-color: #f0f0f0;
        background-size: cover;
        background-position: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .student-field {
        margin-bottom: 16px;
        padding: 14px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        text-align: left;
        font-size: 14px;
        color: #2c3e50;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
      }

      .student-field:hover {
        border-color: #667eea;
      }

      .student-field input {
        width: 100%;
        border: none;
        background: transparent;
        outline: none;
        font-size: 14px;
        color: #2c3e50;
      }

      .qr-code-box {
        width: 140px;
        height: 140px;
        border: 3px solid #e1e8ed;
        border-radius: 12px;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        color: #95a5a6;
      }

      .qr-code-box canvas,
      .qr-code-box img {
        max-width: 100%;
        max-height: 100%;
        border-radius: 8px;
      }

      .update-button {
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 14px 35px;
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.5px;
        cursor: pointer;
        margin-top: 15px;
        text-decoration: none;
        display: inline-block;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .update-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .student-table-wrapper {
        flex: 1;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 20px;
      }

      .add-button {
        float: right;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 10px 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 15px;
        border-radius: 6px;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .add-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 14px 16px;
        text-align: center;
        font-size: 13px;
      }

      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        letter-spacing: 0.3px;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      td {
        color: #2c3e50;
      }

      .action-buttons button {
        border: none;
        background-color: transparent;
        cursor: pointer;
        margin: 0 6px;
        font-size: 18px;
        transition: all 0.2s ease;
        color: #7f8c8d;
      }

      .action-buttons button:hover {
        color: #667eea;
        transform: scale(1.2);
      }

      .action-buttons button:last-child:hover {
        color: #e74c3c;
      }

      .table-body-scroll {
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        margin-top: 10px;
      }

      .table-body-scroll::-webkit-scrollbar {
        width: 8px;
      }

      .table-body-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .table-body-scroll::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 4px;
      }

      .table-body-scroll::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
      }

      .table-body-scroll table {
        width: 100%;
        border-collapse: collapse;
      }

      .table-body-scroll td {
        border-bottom: 1px solid #ecf0f1;
        padding: 14px 16px;
        text-align: center;
        font-size: 13px;
      }

      .table-body-scroll tbody tr {
        transition: background-color 0.2s ease;
      }

      .table-body-scroll tbody tr:hover {
        background-color: #f8f9fa;
      }

      .table-body-scroll tbody tr:last-child td {
        border-bottom: none;
      }

      .footer {
        border-top: 1px solid #e1e8ed;
        text-align: center;
        font-size: 11px;
        color: #95a5a6;
        padding: 20px 0;
        margin-top: 40px;
        background-color: #fff;
      }

      @media (max-width: 1024px) {
        .management-area {
          gap: 20px;
        }

        .student-card {
          width: 100%;
          position: static;
        }

        .student-table-wrapper {
          width: 100%;
        }

        .content {
          padding: 20px;
        }
      }

      @media (max-width: 768px) {
        .menu-toggle {
          display: block;
        }

        .sidebar {
          position: fixed;
          left: 0;
          top: 70px;
          width: 240px;
          height: calc(100vh - 70px);
          z-index: 1000;
          transform: translateX(-100%);
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main-layout {
          flex-direction: column;
        }

        .content {
          flex: 1;
          padding: 15px;
          width: 100%;
        }

        .page-header {
          font-size: 20px;
          margin-bottom: 20px;
        }

        .management-area {
          flex-direction: column;
          gap: 15px;
        }

        .student-card {
          width: 100%;
          padding: 20px;
          text-align: left;
        }

        .avatar {
          width: 80px;
          height: 80px;
          margin: 0 0 16px 0;
        }

        th,
        td {
          padding: 12px 8px;
          font-size: 12px;
        }

        .top-bar {
          padding: 12px 16px;
          font-size: 14px;
        }
      }

      @media (max-width: 480px) {
        .page-header {
          font-size: 18px;
        }

        .student-field input {
          font-size: 14px;
        }

        .update-button {
          width: 100%;
        }

        .add-button {
          width: 100%;
          margin-bottom: 16px;
        }

        th,
        td {
          padding: 10px 6px;
          font-size: 11px;
        }

        .action-buttons button {
          padding: 6px 10px;
          font-size: 11px;
        }

        .top-bar {
          padding: 10px 12px;
        }

        .content {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    {% set nav = nav_items if nav_items is defined else [ {"label": "USER MNGT",
    "endpoint": "admin_dashboard"}, {"label": "STUDENT MNGT", "endpoint":
    "admin_students"}, {"label": "VIEW ATTENDANCE", "endpoint": "#"}, {"label":
    "LOGOUT", "endpoint": "home"} ] %} {% set active = active_endpoint if
    active_endpoint is defined else "admin_students" %} {% set profile =
    student_profile if student_profile is defined else { "id": "0000", "name":
    "Sample, Student", "course": "BSCPE-3" } %} {% set students_list = students
    if students is defined else [] %}
    <div class="top-bar">
      <span>PYTHON (19877) 8:00 - 10:30 A.M MW</span>
      <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    </div>

    <div class="main-layout">
      <div class="sidebar">
        {% for item in nav %} {% set is_link = item.endpoint and item.endpoint
        != "#" %}
        <a
          class="nav-item {% if item.endpoint == active %}active{% endif %}"
          href="{% if is_link %}{{ url_for(item.endpoint) }}{% else %}#{% endif %}"
        >
          {{ item.label }}
        </a>
        {% endfor %}
      </div>

      <div class="content">
        <div class="page-header">STUDENT MANAGEMENT</div>
        <div class="management-area">
          <div class="student-card">
            <div class="avatar"></div>
            <div class="student-field" id="student-id">ID</div>
            <div class="student-field" id="student-name">NAME</div>
            <div class="student-field" id="student-course">COURSE-LEVEL</div>
            <div class="qr-code-box">QR CODE</div>
            <a class="update-button" href="#" onclick="updateStudent()"
              >UPDATE</a
            >
          </div>

          <div class="student-table-wrapper">
            <a
              class="add-button"
              href="{{ url_for('student') }}"
              style="text-decoration: none; display: inline-block"
              >+ADD</a
            >
            <table>
              <thead>
                <tr>
                  <th>IDNO</th>
                  <th>LASTNAME</th>
                  <th>FIRSTNAME</th>
                  <th>COURSE</th>
                  <th>LEVEL</th>
                  <th>ACTION</th>
                </tr>
              </thead>
            </table>

            <div class="table-body-scroll">
              <table>
                <tbody>
                  {% for student in students_list %}
                  <tr>
                    <td>{{ student.id }}</td>
                    <td>{{ student.last }}</td>
                    <td>{{ student.first }}</td>
                    <td>{{ student.course }}</td>
                    <td>{{ student.level }}</td>
                    <td class="action-buttons">
                      <button
                        type="button"
                        onclick="viewStudent('{{ student.id }}')"
                        style="color: blue"
                      >
                        &#9998;
                      </button>
                      <button
                        type="button"
                        onclick="deleteStudent('{{ student.id }}')"
                        style="color: red"
                      >
                        &#128465;
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Copyright &copy; Badilles Govan & Ronan Antoque, 2025
    </div>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
      function toggleMenu() {
        const sidebar = document.querySelector(".sidebar");
        sidebar.classList.toggle("active");
      }

      // Close menu when clicking on a nav item
      document.addEventListener("DOMContentLoaded", function () {
        const navItems = document.querySelectorAll(".nav-item");
        navItems.forEach((item) => {
          item.addEventListener("click", function () {
            document.querySelector(".sidebar").classList.remove("active");
          });
        });
      });

      function viewStudent(studentId) {
        fetch(`/api/student/get/${studentId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const student = data.student;

              // ID stays static
              document.getElementById("student-id").textContent = student.id;

              // Make Name editable
              document.getElementById(
                "student-name"
              ).innerHTML = `<input type="text" id="edit-name" value="${student.lastname}, ${student.firstname}">`;

              // Make Course-Level editable
              document.getElementById(
                "student-course"
              ).innerHTML = `<input type="text" id="edit-course" value="${student.course}-${student.level}">`;

              // Update photo if available
              if (student.photo) {
                const avatar = document.querySelector(".avatar");
                avatar.style.backgroundImage = `url(/${student.photo})`;
                avatar.style.backgroundSize = "cover";
                avatar.style.backgroundPosition = "center";
              }

              // Display QR code
              const qrBox = document.querySelector(".qr-code-box");
              if (student.qr_code) {
                qrBox.innerHTML = `<img src="/${student.qr_code}" alt="QR Code" style="max-width:100%; max-height:100%;">`;
              } else if (typeof QRCode !== "undefined") {
                qrBox.innerHTML = "";
                QRCode.toCanvas(qrBox, student.id, {
                  width: 110,
                  margin: 2,
                }).catch((err) => {
                  console.error("QR generation error:", err);
                  qrBox.innerHTML = "QR CODE";
                });
              }
            }
          })
          .catch((error) => {
            alert("Error loading student: " + error.message);
          });
      }

      function updateStudent() {
        const studentId = document.getElementById("student-id").textContent;
        const fullName = document
          .getElementById("student-name")
          .querySelector("input")
          .value.trim();
        const courseLevel = document
          .getElementById("student-course")
          .querySelector("input")
          .value.trim();

        if (!fullName || !courseLevel) {
          alert("Name and Course-Level cannot be empty");
          return;
        }

        // Split full name
        const [lastName, firstName] = fullName.split(",").map((s) => s.trim());

        // Split course-level
        const [course, level] = courseLevel.split("-").map((s) => s.trim());

        fetch(`/api/student/update/${studentId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            firstname: firstName,
            lastname: lastName,
            course: course,
            level: level,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              alert("Student updated successfully");

              // Update the table row directly
              const rows = document.querySelectorAll(
                ".table-body-scroll tbody tr"
              );
              rows.forEach((row) => {
                if (row.children[0].textContent === studentId) {
                  row.children[1].textContent = lastName;
                  row.children[2].textContent = firstName;
                  row.children[3].textContent = course;
                  row.children[4].textContent = level;
                }
              });
            } else {
              alert(data.message || "Failed to update student");
            }
          })
          .catch((err) => {
            alert("Error: " + err.message);
          });
      }

      function deleteStudent(studentId) {
        if (!confirm("Are you sure you want to delete this student?")) {
          return;
        }

        fetch(`/api/student/delete/${studentId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Student deleted successfully");
              window.location.reload();
            } else {
              alert(data.message || "Error deleting student");
            }
          })
          .catch((error) => {
            alert("Error: " + error.message);
          });
      }
    </script>
  </body>
</html>
